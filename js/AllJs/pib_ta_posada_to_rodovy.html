<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>ПІБ, Звання та Посади (v4.0)</title>
    <style>
        body { font-family: sans-serif; max-width: 1200px; margin: 20px auto; padding: 20px; background: #f0f4f8; }
        .box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stats { background: #e3f2fd; color: #0d47a1; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }
        textarea { width: 100%; height: 250px; border: 1px solid #ccc; border-radius: 8px; padding: 15px; font-size: 14px; margin-bottom: 15px; box-sizing: border-box; }
        .btns { display: flex; gap: 10px; margin-bottom: 20px; }
        button { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-run { background: #1976d2; color: white; flex-grow: 1; }
        .btn-copy { background: #388e3c; color: white; }
        .btn-clear { background: #d32f2f; color: white; }
        .res-area { background: #fff; border: 1px solid #ccc; padding: 20px; min-height: 200px; white-space: pre-wrap; border-radius: 8px; font-family: 'Courier New', monospace; line-height: 1.6; }
        .errors { margin-top: 20px; background: #fee; padding: 15px; color: #c00; border-radius: 8px; display: none; }
    </style>
</head>
<body>

<div class="box">
    <h2>Схилення: Звання ПІБ Посада</h2>

    <div id="stats" class="stats">Рядків: 0 | Оброблено: 0</div>

    <textarea id="input" placeholder="Приклад: солдат АНОХІН Олександр Іванович тесляр...&#10;молодший сержант БОНДАРЕНКО Андрій Вікторович механік..."></textarea>

    <div class="btns">
        <button class="btn-run" onclick="process()">ОБРОБИТИ ВСЕ</button>
        <button class="btn-copy" onclick="copy()">КОПІЮВАТИ</button>
        <button class="btn-clear" onclick="clearAll()">ОЧИСТИТИ</button>
    </div>

    <div id="output" class="res-area"></div>

    <div id="errors" class="errors">
        <strong>Помилки (не знайдено прізвище ВЕРХНІМ регістром або неповні дані):</strong>
        <div id="err-list"></div>
    </div>
</div>

<script>
function capitalize(s) {
    if (!s) return "";
    return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
}

function declineNoun(word) {
    if (!word) return word;
    let w = word.toLowerCase();

    // Специальное правило для "штаб" (в контексте штаб-сержанта не склоняется)
    if (w === "штаб") return word;

    // Группа на -ар (тесляр)
    if (w.endsWith('ар') || w.endsWith('яр')) return word + 'а'; 
    // Мягкая группа (водій)
    if (w.endsWith('ій')) return word.slice(0, -2) + 'ія'; 
    // Прилагательные (головний, молодший)
    if (w.endsWith('ий')) return word.slice(0, -2) + 'ого';
    if (w.endsWith('ій') && w.length > 4) return word.slice(0, -2) + 'ого'; // старшій -> старшого
    // Мягкий знак (Цись, Гудзь)
    if (w.endsWith('ь')) return word.slice(0, -1) + 'я';
    // На согласный
    if (w.match(/[бвгґджзклмнпрстфхцчшщ]$/)) return word + 'а';
    
    return word;
}

function processRow(row) {
    // Чистим пробелы и апостроф
    let clean = row.replace(/['`‘’"“”]/g, "’").replace(/\s+/g, " ").trim();
    let parts = clean.split(" ");
    
    // Ищем индекс фамилии (первое слово всеми заглавными)
    let fIndex = parts.findIndex(p => p.length > 1 && p === p.toUpperCase() && !p.match(/[0-9]/));
    
    // Нужно, чтобы была фамилия, имя и отчество (как минимум 3 слова после индекса фамилии нет, но проверим наличие)
    if (fIndex === -1 || parts.length < fIndex + 3) return null;

    let rankParts = parts.slice(0, fIndex);
    let f = parts[fIndex];
    let n = parts[fIndex + 1];
    let p = parts[fIndex + 2];
    let jobParts = parts.slice(fIndex + 3);

    const pLow = p.toLowerCase();
    const isFemale = pLow.endsWith('івна') || pLow.endsWith('івни');
    const gender = isFemale ? 'female' : 'male';

    // 1. Склоняем Звание
    // Проверяем на "штаб-сержант" (через дефис или пробелы)
    let processedRank = [];
    if (rankParts.length > 0) {
        // Склеиваем и смотрим, есть ли там штаб-сержант
        let rankStr = rankParts.join(" ").toLowerCase();
        if (rankStr.includes("штаб") && rankStr.includes("сержант")) {
            // В этой конструкции "штаб" не трогаем
            rankParts.forEach(part => {
                if (part.toLowerCase() === "штаб") processedRank.push(part);
                else processedRank.push(declineNoun(part));
            });
        } else {
            // Склоняем все слова звания
            rankParts.forEach(part => {
                processedRank.push(declineNoun(part));
            });
        }
    }

    // 2. Склоняем ФИО
    // Отчество
    if (gender === 'male' && pLow.endsWith('ович')) p = p.slice(0, -4) + 'овича';
    else if (gender === 'female' && pLow.endsWith('івна')) p = p.slice(0, -4) + 'івни';
    p = capitalize(p);

    // Имя
    let nLow = n.toLowerCase();
    if (nLow === 'ілля') n = 'Іллі';
    else if (nLow === 'лев') n = 'Лева';
    else if (nLow.endsWith('ій')) n = n.slice(0, -2) + 'ія';
    else if (nLow.endsWith('я')) n = n.slice(0, -1) + 'і';
    else if (nLow.endsWith('о')) n = n.slice(0, -1) + 'а';
    else if (nLow.endsWith('а')) n = n.slice(0, -1) + 'и';
    else if (gender === 'male' && nLow.match(/[бвгґджзклмнпрстфхцчшщ]$/)) n += 'а';
    n = capitalize(n);

    // Фамилия
    let fLow = f.toLowerCase();
    if (fLow.endsWith('ий') || fLow.endsWith('ій')) {
        f = (gender === 'male') ? f.slice(0, -2) + 'ого' : f.slice(0, -2) + 'ої';
    } else if (fLow.endsWith('а')) f = f.slice(0, -1) + 'и';
    else if (fLow.endsWith('я')) f = f.slice(0, -1) + 'і';
    else if (gender === 'male') {
        if (fLow.endsWith('о')) f = f.slice(0, -1) + 'а';
        else if (fLow.endsWith('ь')) f = f.slice(0, -1) + 'я'; 
        else if (fLow.match(/[бвгґджзклмнпрстфхцчшщ]$/)) f += 'а';
    }
    f = f.toUpperCase();

    // 3. Склоняем Должность (первое слово или составное через дефис)
    if (jobParts.length >= 3 && (jobParts[1] === "–" || jobParts[1] === "-" || jobParts[1] === "—")) {
        jobParts[0] = declineNoun(jobParts[0]);
        jobParts[2] = declineNoun(jobParts[2]);
    } else if (jobParts.length > 0) {
        jobParts[0] = declineNoun(jobParts[0]);
    }

    return `${processedRank.join(" ")} ${f} ${n} ${p} ${jobParts.join(" ")}`.replace(/\s+/g, " ");
}

function process() {
    const input = document.getElementById('input').value;
    const lines = input.split('\n').filter(l => l.trim() !== '');
    let res = [], err = [];

    lines.forEach(line => {
        let r = processRow(line);
        r ? res.push(r) : err.push(line);
    });

    document.getElementById('output').innerText = res.join('\n');
    document.getElementById('stats').innerText = `Рядків: ${lines.length} | Успішно: ${res.length}`;
    
    if (err.length > 0) {
        document.getElementById('errors').style.display = 'block';
        document.getElementById('err-list').innerText = err.join('\n');
    } else {
        document.getElementById('errors').style.display = 'none';
    }
}

function copy() {
    const text = document.getElementById('output').innerText;
    if (text) navigator.clipboard.writeText(text).then(() => alert('Результат скопійовано!'));
}

function clearAll() {
    document.getElementById('input').value = '';
    document.getElementById('output').innerText = '';
    document.getElementById('stats').innerText = 'Рядків: 0 | Оброблено: 0';
    document.getElementById('errors').style.display = 'none';
}
</script>
</body>
</html>